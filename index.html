<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mandrilos Mechanic ‚Äì Control Panel</title>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    :root{
      --bg:#0a0a0a;
      --panel:#111;
      --panel2:#141414;
      --line:#2a2a2a;
      --text:#eaeaea;
      --muted:#a9a9a9;
      --accent:#e53935;
      --danger:#b71c1c;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: Arial, Helvetica, sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    header{
      background:#000;
      border-bottom:1px solid #111;
      display:flex;
      align-items:center;
      gap:14px;
      padding:14px 18px;
    }
    .logo{ height:54px; width:auto; display:block; }
    .brand{ display:flex; flex-direction:column; line-height:1.1; }
    .brand .title{
      font-weight:900;
      letter-spacing:2px;
      font-size:18px;
    }
    .brand .sub{
      font-size:12px;
      color:var(--muted);
      margin-top:4px;
      letter-spacing:1px;
    }

    .tabs{
      background:#0d0d0d;
      border-bottom:1px solid #1c1c1c;
      padding:12px 12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .tab{
      padding:10px 14px;
      border-radius:10px;
      border:1px solid #2c2c2c;
      background:#151515;
      color:var(--text);
      cursor:pointer;
      font-weight:800;
      letter-spacing:.5px;
      transition:.15s;
    }
    .tab:hover{ transform:translateY(-1px); }
    .tab.active{
      background:var(--accent);
      border-color:var(--accent);
    }

    .wrap{ padding:18px; }
    .section{ display:none; animation:fade .18s ease; }
    .section.active{ display:block; }
    @keyframes fade{
      from{ opacity:0; transform:translateY(5px); }
      to{ opacity:1; transform:none; }
    }

    .box{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      margin:12px 0;
      max-width:1100px;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    input{
      background:#1a1a1a;
      border:1px solid #333;
      color:#fff;
      border-radius:10px;
      padding:10px 12px;
      min-width:240px;
      outline:none;
    }
    input:focus{ border-color:#555; }

    .btn{
      border:none;
      border-radius:10px;
      padding:10px 14px;
      font-weight:900;
      cursor:pointer;
      background:var(--accent);
      color:#fff;
      transition:.15s;
      letter-spacing:.3px;
      width:auto;
    }
    .btn:hover{ opacity:.95; transform:translateY(-1px); }
    .btn:active{ transform:translateY(0px); }
    .btn.dark{ background:#2a2a2a; }
    .btn.danger{ background:var(--danger); }

    .notice{
      font-size:13px;
      color:var(--muted);
      margin-top:8px;
      line-height:1.35;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      max-width:1100px;
    }
    @media (max-width: 860px){
      .grid{ grid-template-columns: 1fr; }
    }
    .item{
      background:var(--panel2);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .item .name{ font-weight:900; }
    .item .small{ font-size:12px; color:var(--muted); margin-top:4px; }
    .item .actions{ display:flex; gap:10px; align-items:center; }
    .qty{
      min-width:32px;
      text-align:center;
      font-weight:900;
      color:#9ef7d5;
    }

    .kpis{
      display:grid;
      grid-template-columns: repeat(4, minmax(180px, 1fr));
      gap:10px;
      max-width:1100px;
    }
    @media (max-width: 860px){
      .kpis{ grid-template-columns: 1fr; }
    }
    .kpi{
      background:#0f0f0f;
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
    }
    .kpi .label{ font-size:12px; color:var(--muted); }
    .kpi .val{ font-size:18px; font-weight:900; margin-top:4px; }

    table{
      width:min(1100px,100%);
      border-collapse:collapse;
      overflow:hidden;
      border-radius:14px;
    }
    th,td{
      border:1px solid #303030;
      padding:8px;
      text-align:center;
    }
    th{
      background:#0f0f0f;
      color:#ff7b78;
      font-weight:900;
    }
    td{ background:#0c0c0c; }
    td.left{ text-align:left; }

    .toast{
      position:fixed;
      right:16px;
      bottom:16px;
      background:#1d1d1d;
      border:1px solid #333;
      color:#fff;
      padding:10px 12px;
      border-radius:14px;
      opacity:0;
      transform:translateY(8px);
      transition:.18s;
      z-index:9999;
      max-width: 90vw;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .toast.show{ opacity:1; transform:none; }
  </style>
</head>

<body>
  <header>
    <img src="assets/logo.png" class="logo" alt="Mandrilos Logo">
    <div class="brand">
      <div class="title">MANDRILOS MECHANIC</div>
      <div class="sub">Control Panel</div>
    </div>
  </header>

  <div class="tabs">
    <button class="tab active" data-target="customer">Customer</button>
    <button class="tab" data-target="mechanic">Mehaniƒçar</button>
    <button class="tab" data-target="public">Statistika</button>
    <button class="tab" data-target="nitro">Nitro</button>
    <button class="tab" data-target="admin">Admin</button>
  </div>

  <div class="wrap">

    <!-- RACUN -->
    <section id="customer" class="section active">
      <h2>Raƒçun za mu≈°teriju</h2>
      <div class="box">
        <div class="notice">Mu≈°terija vidi stavke + konaƒçnu cenu.</div>
        <div id="customerList" class="notice" style="margin-top:10px"></div>

        <div class="kpis" style="margin-top:12px; grid-template-columns: 1fr;">
          <div class="kpi">
            <div class="label">UKUPNO</div>
            <div class="val" id="custTotal">0$</div>
          </div>
        </div>
      </div>
    </section>

    <!-- MEHANIƒåAR -->
    <section id="mechanic" class="section">
      <h2>Mehaniƒçar</h2>

      <div class="box">
        <div class="row">
          <input id="mechName" placeholder="Unesi svoje ime (npr. Markoviƒá)">
          <button class="btn" id="btnLogin">UƒêI</button>
          <button class="btn dark" id="btnLogout">ODJAVA</button>
        </div>
        <div class="notice">Ulogovan: <b id="mechLabel">‚Äî</b></div>
        <div class="notice">Tek kad se uloguje≈°, pojavljuje se meni sa delovima.</div>
      </div>

      <!-- MENI SA DELOVIMA -->
      <div class="box" id="jobBox" style="display:none">
        <h3>Dodaj posao (+1)</h3>
        <div id="jobGrid" class="grid"></div>

        <div class="kpis" style="margin-top:12px">
          <div class="kpi">
            <div class="label">UKUPNO ZA MU≈†TERIJU</div>
            <div class="val" id="custTotalMech">0$</div>
          </div>
          <div class="kpi">
            <div class="label">ZA BANKU (FIRMA) ‚Äì DU≈ΩAN SI DA UPLATI≈†</div>
            <div class="val" id="bankDue">0$</div>
          </div>
          <div class="kpi">
            <div class="label">MOJA ZARADA SADA</div>
            <div class="val" id="meNowProfit">0$</div>
          </div>
          <div class="kpi">
            <div class="label">BONUS PROCENA (10% Full/Sound)</div>
            <div class="val" id="bonusEstimate">0$</div>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn" id="btnDone">‚úÖ GOTOVO</button>
          <button class="btn dark" id="btnClear">üßπ Oƒçisti</button>
        </div>

        <div class="notice">
          Full tune + Custom sound: cela naplata ide u banku, bonus 10% se obraƒçuna na kraju nedelje (admin).
        </div>
      </div>
    </section>

    <!-- PUBLIC -->
    <section id="public" class="section">
      <h2>Javna statistika (svi vide)</h2>
      <div class="box">
        <table>
          <thead><tr><th>Mehaniƒçar</th><th>Full tune</th><th>Custom sound</th></tr></thead>
          <tbody id="publicBody"></tbody>
        </table>
      </div>
    </section>

    <!-- NITRO -->
    <section id="nitro" class="section">
      <h2>Nitro & Materijali (live)</h2>
      <div class="box">
        <div class="notice">Samo svoj red mo≈æe≈° da menja≈°. Ostalo je read-only.</div>
        <table>
          <thead>
            <tr>
              <th>Ime</th><th>Nitro</th><th>Guma (Tire)</th><th>Aluminijum (Aluminum)</th><th>ƒåelik (Steel)</th><th>Skarp (Scrap)</th>
            </tr>
          </thead>
          <tbody id="nitroBody"></tbody>
        </table>
      </div>
    </section>

    <!-- ADMIN -->
    <section id="admin" class="section">
      <h2>Admin</h2>

      <div class="box" id="adminLock">
        <div class="row">
          <input type="password" id="adminPin" placeholder="PIN (12345)">
          <button class="btn" id="btnAdminUnlock">OTKLJUƒåAJ</button>
        </div>
        <div class="notice">Admin vidi ‚ÄúGOTOVO‚Äù raƒçune + filter po datumima.</div>
      </div>

      <div id="adminPanel" style="display:none">

        <div class="box">
          <h3>Gotovo ‚Äì pregledi (raƒçuni)</h3>
          <div class="row">
            <input type="date" id="fromDate">
            <input type="date" id="toDate">
            <button class="btn" id="btnFilterInvoices">üîé Filtriraj</button>
            <button class="btn dark" id="btnClearFilter">‚úñ Reset filter</button>
          </div>

          <table style="margin-top:12px">
            <thead>
              <tr>
                <th>Datum</th>
                <th>Mehaniƒçar</th>
                <th>Mu≈°terija</th>
                <th>Banka</th>
                <th>Zarada</th>
                <th>Stavke</th>
              </tr>
            </thead>
            <tbody id="invoiceBody"></tbody>
          </table>

          <div class="notice">Svaki klik ‚ÄúGOTOVO‚Äù pravi jedan zapis sa datumom, ukupnim i internom raƒçunicom.</div>
        </div>

        <div class="box">
          <h3>Nitro ‚Äì Admin</h3>
          <div class="row">
            <button class="btn" id="btnNitroCSV">üì§ Export Nitro CSV</button>
            <button class="btn" id="btnNitroTXT">üì§ Export Nitro TXT</button>
            <button class="btn danger" id="btnNitroReset">üîÑ Reset Nitro</button>
          </div>
          <div class="notice">Reset bri≈°e samo Nitro podatke.</div>
        </div>

      </div>
    </section>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    /* ===================== FIREBASE INIT ===================== */
    firebase.initializeApp({
      apiKey: "AIzaSyAbxxQyWyf9iAT_AE9b-o41BRqcrnXaNy8",
      authDomain: "nitro-55cdd.firebaseapp.com",
      databaseURL: "https://nitro-55cdd-default-rtdb.firebaseio.com",
      projectId: "nitro-55cdd",
      storageBucket: "nitro-55cdd.appspot.com",
      messagingSenderId: "365206404307",
      appId: "1:365206404307:web:794d0420e125760a572826"
    });
    const db = firebase.database();

    /* ===================== PRICES =====================
      - cust: koliko plaƒáa mu≈°terija
      - cost: koliko ‚Äúko≈°ta firmu‚Äù (to se vraƒáa u banku, kod duplo stavki)
      Full/Sound: cela naplata ide u banku; bonus se raƒçuna na profitu (cust-cost)
    */
    const PRICES = {
      full:{cust:100000, cost:35000},        // profit 65000
      sound:{cust:200000, cost:150000},      // profit 50000

      tint:{cust:2400, cost:1200},
      paint:{cust:2400, cost:1200},
      stance:{cust:50000, cost:25000},
      wsize:{cust:50000, cost:25000},
      wwidth:{cust:50000, cost:25000},
      rims:{cust:6000, cost:3000},
      drift:{cust:7500, cost:3750},
      xenon:{cust:6000, cost:3000},
      neon:{cust:20000, cost:10000},
      horn:{cust:1500, cost:750},
      armor:{cust:9000, cost:4500},
      wash:{cust:1000, cost:500},
      repair:{cust:4000, cost:2000},
      tracker:{cust:2400, cost:1200}
    };

    const JOBS_UI = [
      {k:"full",  title:"Full tune", sub:"Kompletan tuning"},
      {k:"sound", title:"Custom sound", sub:"Poseban zvuk"},
      {k:"tint",  title:"Window tint", sub:"Zatamnjivanje"},
      {k:"paint", title:"Paint", sub:"Farbanje"},
      {k:"stance",title:"Wheels stance", sub:"Stance"},
      {k:"wsize", title:"Wheel size", sub:"Veliƒçina toƒçka"},
      {k:"wwidth",title:"Wheel width", sub:"≈†irina felne"},
      {k:"rims",  title:"Rims", sub:"Felne"},
      {k:"drift", title:"Drift tires", sub:"Drift gume"},
      {k:"xenon", title:"Xenon", sub:"Xenon svetla"},
      {k:"neon",  title:"Neons", sub:"Neoni"},
      {k:"horn",  title:"Horn", sub:"Sirena"},
      {k:"armor", title:"Armor", sub:"Oklop"},
      {k:"wash",  title:"Wash", sub:"Pranje"},
      {k:"repair",title:"Repair", sub:"Popravka"},
      {k:"tracker",title:"Tracker", sub:"Lokator"}
    ];

    /* ===================== STATE ===================== */
    let mech = localStorage.getItem("mechanic") || "";
    let adminUnlocked = false;
    let cart = {}; // trenutni ‚Äúauto‚Äù (pre GOTOVO)

    const $ = (id)=>document.getElementById(id);
    const money = (n)=>(Number(n)||0).toLocaleString()+"$";

    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"), 1200);
    }

    function setTab(targetId){
      document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
      document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
      document.querySelector(`.tab[data-target="${targetId}"]`)?.classList.add("active");
      $(targetId)?.classList.add("active");
    }

    function labelItem(k){
      const map = {
        full:"Full tune (Kompletan tuning)",
        sound:"Custom sound (Poseban zvuk)",
        tint:"Window tint (Zatamnjivanje)",
        paint:"Paint (Farbanje)",
        stance:"Wheels stance (Stance)",
        wsize:"Wheel size (Veliƒçina toƒçka)",
        wwidth:"Wheel width (≈†irina felne)",
        rims:"Rims (Felne)",
        drift:"Drift tires (Drift gume)",
        xenon:"Xenon (Xenon svetla)",
        neon:"Neons (Neoni)",
        horn:"Horn (Sirena)",
        armor:"Armor (Oklop)",
        wash:"Wash (Pranje)",
        repair:"Repair (Popravka)",
        tracker:"Tracker (Lokator)"
      };
      return map[k] || k;
    }

    /* ===================== CORE CALC (REAL-TIME) =====================
      Rules:
      - Full/Sound: banka += cust (100%), mehaniƒçar zarada sada = 0
                   bonusBase += (cust - cost)
      - Ostalo (duplo): banka += cost, zarada sada += (cust - cost)
    */
    function calcCartBreakdown(){
      let custTotal = 0;
      let bankDue = 0;
      let mechProfitNow = 0;
      let bonusBase = 0;

      Object.keys(cart).forEach(k=>{
        const qty = cart[k]||0;
        if(qty<=0) return;

        const p = PRICES[k];
        const cust = (p?.cust||0) * qty;
        const cost = (p?.cost||0) * qty;

        custTotal += cust;

        if(k === "full" || k === "sound"){
          bankDue += cust;                 // sve u banku
          bonusBase += (cust - cost);      // profit na koji ide 10%
        } else {
          bankDue += cost;                // vrati firmi koliko je skripta uzela
          mechProfitNow += (cust - cost); // zarada mehaniƒçara
        }
      });

      const bonusEstimate = Math.round(bonusBase * 0.10);
      return {custTotal, bankDue, mechProfitNow, bonusEstimate};
    }

    function renderCustomer(){
      let lines = [];
      Object.keys(cart).forEach(k=>{
        const qty = cart[k]||0;
        if(!qty) return;
        const price = PRICES[k].cust * qty;
        lines.push(`${labelItem(k)} x${qty} ‚Üí ${money(price)}`);
      });
      const {custTotal} = calcCartBreakdown();
      $("customerList").innerHTML = lines.length ? lines.join("<br>") : "Nema unosa jo≈°.";
      $("custTotal").textContent = money(custTotal);
    }

    function renderMechanicRealtime(){
      const r = calcCartBreakdown();
      $("custTotalMech").textContent = money(r.custTotal);
      $("bankDue").textContent = money(r.bankDue);
      $("meNowProfit").textContent = money(r.mechProfitNow);
      $("bonusEstimate").textContent = money(r.bonusEstimate);
    }

    function clearCart(){
      cart = {};
      document.querySelectorAll('[id^="qty_"]').forEach(x=>x.textContent="0");
      renderCustomer();
      renderMechanicRealtime();
    }

    /* ===================== PUBLIC STATS ===================== */
    db.ref("publicStats").on("value", snap=>{
      const tb = $("publicBody");
      tb.innerHTML = "";
      snap.forEach(m=>{
        const v=m.val()||{};
        tb.innerHTML += `<tr><td>${m.key}</td><td>${v.full||0}</td><td>${v.sound||0}</td></tr>`;
      });
    });

    /* ===================== NITRO ===================== */
    const nitroRef = db.ref("nitro");

    function ensureNitroRow(name){
      if(!name) return;
      nitroRef.child(name).once("value").then(s=>{
        if(!s.exists()){
          nitroRef.child(name).set({nitro:0,tire:0,aluminum:0,steel:0,scrap:0});
        }
      });
    }

    function updateNitro(name, key, value){
      const v = Math.max(0, Number(value)||0);
      nitroRef.child(name).child(key).set(v);
    }

    nitroRef.on("value", snap=>{
      const tb = $("nitroBody");
      tb.innerHTML = "";
      snap.forEach(m=>{
        const d = m.val()||{};
        const canEdit = (m.key === mech);

        const cell = (key,val)=>{
          if(!canEdit) return `<td>${val||0}</td>`;
          return `<td><input data-nname="${m.key}" data-nkey="${key}" type="number" min="0" value="${val||0}" style="min-width:90px"></td>`;
        };

        tb.innerHTML += `
          <tr>
            <td>${m.key}</td>
            ${cell("nitro",d.nitro)}
            ${cell("tire",d.tire)}
            ${cell("aluminum",d.aluminum)}
            ${cell("steel",d.steel)}
            ${cell("scrap",d.scrap)}
          </tr>
        `;
      });

      tb.querySelectorAll("input[data-nname]").forEach(inp=>{
        inp.addEventListener("change", ()=>{
          updateNitro(inp.dataset.nname, inp.dataset.nkey, inp.value);
        });
      });
    });

    /* ===================== INVOICES (GOTOVO) ===================== */
    const invoicesRef = db.ref("invoices");

    function buildInvoiceItems(){
      const items = [];
      Object.keys(cart).forEach(k=>{
        const qty = cart[k]||0;
        if(qty>0){
          items.push({
            key:k,
            label: labelItem(k),
            qty,
            unit: PRICES[k].cust,
            subtotal: PRICES[k].cust * qty
          });
        }
      });
      return items;
    }

    function finishInvoice(){
      if(!mech) return alert("Uloguj se imenom prvo.");
      const items = buildInvoiceItems();
      if(items.length===0) return alert("Nema stavki.");

      const breakdown = calcCartBreakdown();

      // snimi jedan ‚Äúraƒçun‚Äù
      invoicesRef.push({
        mechanic: mech,
        time: Date.now(),
        customerTotal: breakdown.custTotal,
        bankDue: breakdown.bankDue,
        mechanicProfitNow: breakdown.mechProfitNow,
        bonusEstimate: breakdown.bonusEstimate,
        items
      });

      toast("Saƒçuvano: GOTOVO");
      clearCart();
      setTab("customer");
    }

    /* ===================== ADMIN INVOICES + FILTER ===================== */
    function renderInvoices(list){
      const tb = $("invoiceBody");
      tb.innerHTML = "";
      list.sort((a,b)=>b.time-a.time);

      list.forEach(inv=>{
        const dt = new Date(inv.time).toLocaleString();
        const itemsText = (inv.items||[]).map(i=>`${i.label} x${i.qty}`).join(", ");
        tb.innerHTML += `
          <tr>
            <td>${dt}</td>
            <td>${inv.mechanic || ""}</td>
            <td>${money(inv.customerTotal||0)}</td>
            <td>${money(inv.bankDue||0)}</td>
            <td>${money(inv.mechanicProfitNow||0)}</td>
            <td class="left">${itemsText}</td>
          </tr>
        `;
      });
    }

    function getDateRange(){
      const f = $("fromDate")?.value;
      const t = $("toDate")?.value;
      const fromMs = f ? new Date(f+"T00:00:00").getTime() : null;
      const toMs   = t ? new Date(t+"T23:59:59").getTime() : null;
      return {fromMs, toMs};
    }

    function applyInvoiceFilter(){
      const all = window.__allInvoices || [];
      const {fromMs, toMs} = getDateRange();

      const filtered = all.filter(inv=>{
        if(fromMs && inv.time < fromMs) return false;
        if(toMs && inv.time > toMs) return false;
        return true;
      });

      renderInvoices(filtered);
    }

    function bindInvoicesLive(){
      if(!adminUnlocked) return;
      invoicesRef.limitToLast(800).on("value", snap=>{
        const all=[];
        snap.forEach(s=>all.push(s.val()));
        window.__allInvoices = all;
        applyInvoiceFilter();
      });
    }

    /* ===================== ADMIN: NITRO EXPORT/RESET ===================== */
    function downloadFile(filename, content, type){
      const blob = new Blob([content], {type});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href=url; a.download=filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function exportNitroCSV(){
      if(!adminUnlocked) return alert("Admin samo");
      db.ref("nitro").once("value").then(snap=>{
        let csv="mechanic,nitro,tire,aluminum,steel,scrap\n";
        snap.forEach(s=>{
          const d=s.val()||{};
          csv += `${s.key},${d.nitro||0},${d.tire||0},${d.aluminum||0},${d.steel||0},${d.scrap||0}\n`;
        });
        downloadFile("nitro.csv", csv, "text/csv");
      });
    }

    function exportNitroTXT(){
      if(!adminUnlocked) return alert("Admin samo");
      db.ref("nitro").once("value").then(snap=>{
        let txt="NITRO LISTING\n\n";
        snap.forEach(s=>{
          const d=s.val()||{};
          txt += `${s.key}: NITRO ${d.nitro||0}, TIRE ${d.tire||0}, ALU ${d.aluminum||0}, STEEL ${d.steel||0}, SCRAP ${d.scrap||0}\n`;
        });
        downloadFile("nitro.txt", txt, "text/plain");
      });
    }

    function resetNitro(){
      if(!adminUnlocked) return alert("Admin samo");
      if(!confirm("SIGURNO? Ovo bri≈°e sve Nitro podatke!")) return;
      db.ref("nitro").remove();
      toast("Nitro resetovan");
    }

    /* ===================== JOB BUTTONS ===================== */
    function buildJobButtons(){
      const grid = $("jobGrid");
      grid.innerHTML = "";

      JOBS_UI.forEach(j=>{
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div>
            <div class="name">${j.title}</div>
            <div class="small">${j.sub}</div>
          </div>
          <div class="actions">
            <span class="qty" id="qty_${j.k}">0</span>
            <button class="btn" data-job="${j.k}">+1</button>
          </div>
        `;
        grid.appendChild(el);
      });

      grid.querySelectorAll("button[data-job]").forEach(b=>{
        b.addEventListener("click", ()=>{
          if(!mech){ alert("Uloguj se imenom prvo."); return; }

          const k = b.dataset.job;
          cart[k] = (cart[k]||0)+1;
          $("qty_"+k).textContent = cart[k];

          // log za public stats
          if(k==="full" || k==="sound"){
            db.ref("publicStats/"+mech+"/"+k).transaction(v=>(v||0)+1);
          }

          renderCustomer();
          renderMechanicRealtime();
          toast("Dodato: "+labelItem(k));
        });
      });
    }

    /* ===================== AUTH ===================== */
    function loginMechanic(){
      const name = $("mechName").value.trim();
      if(!name) return alert("Unesi ime");
      mech = name;
      localStorage.setItem("mechanic", mech);
      $("mechLabel").textContent = mech;
      $("jobBox").style.display = "block";
      ensureNitroRow(mech);
      renderMechanicRealtime();
      toast("Ulogovan: "+mech);
    }

    function logoutMechanic(){
      mech = "";
      localStorage.removeItem("mechanic");
      $("mechLabel").textContent = "‚Äî";
      $("jobBox").style.display = "none";
      clearCart();
      toast("Odjava");
    }

    function unlockAdmin(){
      const pin = $("adminPin").value;
      if(pin === "2468"){
        adminUnlocked = true;
        $("adminLock").style.display = "none";
        $("adminPanel").style.display = "block";
        bindInvoicesLive();
        toast("Admin OK");
      }else{
        alert("Pogre≈°an PIN");
      }
    }

    /* ===================== INIT ===================== */
    document.addEventListener("DOMContentLoaded", ()=>{
      document.querySelectorAll(".tab").forEach(b=>{
        b.addEventListener("click", ()=>setTab(b.dataset.target));
      });

      $("btnLogin").addEventListener("click", loginMechanic);
      $("btnLogout").addEventListener("click", logoutMechanic);

      $("btnDone").addEventListener("click", finishInvoice);
      $("btnClear").addEventListener("click", ()=>{ clearCart(); toast("Oƒçi≈°ƒáeno"); });

      $("btnAdminUnlock").addEventListener("click", unlockAdmin);

      $("btnFilterInvoices").addEventListener("click", applyInvoiceFilter);
      $("btnClearFilter").addEventListener("click", ()=>{
        $("fromDate").value="";
        $("toDate").value="";
        applyInvoiceFilter();
      });

      $("btnNitroCSV").addEventListener("click", exportNitroCSV);
      $("btnNitroTXT").addEventListener("click", exportNitroTXT);
      $("btnNitroReset").addEventListener("click", resetNitro);

      buildJobButtons();

      if(mech){
        $("mechLabel").textContent = mech;
        $("jobBox").style.display = "block";
        ensureNitroRow(mech);
      }

      renderCustomer();
      renderMechanicRealtime();
    });
  </script>
</body>
</html>


