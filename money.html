<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sekretarica – Control Panel</title>

  <style>
    :root{
      --bg:#0a0a0a; --panel:#111; --panel2:#141414; --line:#2a2a2a;
      --text:#eaeaea; --muted:#a9a9a9; --accent:#e53935; --danger:#b71c1c;
      --ok:#1db954;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:Arial,Helvetica,sans-serif; background:var(--bg); color:var(--text); }
    header{ background:#000; border-bottom:1px solid #111; display:flex; gap:14px; padding:14px 18px; align-items:center;}
    .brand .title{ font-weight:900; letter-spacing:2px; font-size:18px; }
    .brand .sub{ font-size:12px; color:var(--muted); margin-top:4px; letter-spacing:1px; }

    .tabs{ background:#0d0d0d; border-bottom:1px solid #1c1c1c; padding:12px; display:flex; gap:10px; flex-wrap:wrap; }
    .tab{ padding:10px 14px; border-radius:10px; border:1px solid #2c2c2c; background:#151515; color:var(--text); cursor:pointer; font-weight:800; }
    .tab.active{ background:var(--accent); border-color:var(--accent); }

    .wrap{ padding:18px; }
    .section{ display:none; animation:fade .18s ease; }
    .section.active{ display:block; }
    @keyframes fade{ from{opacity:0; transform:translateY(5px);} to{opacity:1; transform:none;} }

    .box{ background:var(--panel); border:1px solid var(--line); border-radius:14px; padding:14px; margin:12px 0; max-width:1100px;}
    .box h2,.box h3{ margin:0 0 10px 0; }
    .muted{ color:var(--muted); font-size:12px; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; }
    .field{ display:flex; flex-direction:column; gap:6px; min-width:220px; flex:1; }
    label{ font-size:12px; font-weight:800; color:var(--muted); letter-spacing:.5px;}
    input, select, textarea{
      background:var(--panel2); color:var(--text);
      border:1px solid #2b2b2b; border-radius:10px;
      padding:10px 12px; outline:none;
    }
    textarea{ min-height:90px; resize:vertical; }

    .btn{
      padding:10px 14px; border-radius:10px; border:1px solid #2c2c2c;
      background:#151515; color:var(--text); cursor:pointer; font-weight:900;
    }
    .btn.accent{ background:var(--accent); border-color:var(--accent); }
    .btn.danger{ background:var(--danger); border-color:var(--danger); }
    .btn.ok{ background:var(--ok); border-color:var(--ok); color:#0a0a0a;}
    .btn:active{ transform:translateY(1px); }

    .pill{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid #2b2b2b; background:#121212; font-size:12px; }
    .pill strong{ font-size:12px; }

    .list{ display:flex; flex-direction:column; gap:10px; }
    .item{
      background:#0f0f0f; border:1px solid #222; border-radius:14px; padding:12px;
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between;
    }
    .item .left{ min-width:0; flex:1; }
    .title{ font-weight:900; font-size:14px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .meta{ margin-top:6px; display:flex; gap:8px; flex-wrap:wrap; color:var(--muted); font-size:12px; }
    .note{ margin-top:8px; font-size:13px; color:#ddd; white-space:pre-wrap; }
    .actions{ display:flex; gap:8px; flex-direction:column; }
    .small{ padding:8px 10px; border-radius:12px; border:1px solid #2b2b2b; background:#151515; color:var(--text); cursor:pointer; font-weight:900; }
    .small.danger{ border-color:#4a1b1b; color:#ffb6b6; }

    .hr{ height:1px; background:#1e1e1e; margin:12px 0; }
    .grid{ display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(320px,1fr)); }
    .warn{ color:#ffd27a; font-size:12px; }
    .oktxt{ color:#98ffb5; font-size:12px; }
  </style>
</head>

<body>
  <header>
    <div class="brand">
      <div class="title">SEKRETARICA</div>
      <div class="sub">Obaveze • Dete • Finansije • Firma • Ideje</div>
    </div>
    <div style="margin-left:auto; display:flex; gap:10px; align-items:center;">
      <span id="vaultStatus" class="pill"><strong>Vault:</strong> lokalno</span>
      <button id="btnLock" class="btn danger" style="display:none;">Zaključaj</button>
    </div>
  </header>

  <div id="authBox" class="wrap">
    <div class="box">
      <h2 id="authTitle">Unesi PIN</h2>
      <div class="muted" id="authHint">Ko zna PIN ima pristup na ovom telefonu/računaru (localStorage).</div>
      <div class="row" style="margin-top:12px;">
        <div class="field" style="max-width:320px;">
          <label>PIN</label>
          <input id="pinInput" type="password" placeholder="npr. 2468" />
        </div>
        <button id="btnEnter" class="btn accent">Uđi</button>
      </div>
    </div>
  </div>

  <div id="app" style="display:none;">
    <div class="tabs">
      <button class="tab active" data-tab="today">Danas</button>
      <button class="tab" data-tab="calendar">Kalendar</button>
      <button class="tab" data-tab="quick">Brzi unos</button>
      <button class="tab" data-tab="finance">Finansije</button>
      <button class="tab" data-tab="child">Dete</button>
      <button class="tab" data-tab="settings">Podešavanja</button>
    </div>

    <div class="wrap">
      <!-- TODAY -->
      <div class="section active" id="tab-today">
        <div class="grid">
          <div class="box">
            <h3>Danas</h3>
            <div id="todayList" class="list"></div>
            <div id="todayEmpty" class="muted" style="display:none;">Nema događaja za danas.</div>
          </div>

          <div class="box">
            <h3>Sledeće (20)</h3>
            <div id="upcomingList" class="list"></div>
            <div class="muted">Tip: U “Brzi unos” dodaješ sve (termini, sud, ideje, finansije).</div>
          </div>
        </div>
      </div>

      <!-- CALENDAR -->
      <div class="section" id="tab-calendar">
        <div class="box">
          <h3>Kalendar (list view)</h3>
          <div class="muted">Sortirano po datumu. Možeš obrisati ili označiti “Done”.</div>
          <div class="hr"></div>
          <div id="calendarList" class="list"></div>
        </div>
      </div>

      <!-- QUICK ADD -->
      <div class="section" id="tab-quick">
        <div class="box">
          <h3>Brzi unos</h3>
          <div class="row">
            <div class="field">
              <label>Tip</label>
              <select id="qaType">
                <option value="appointment">Termin (firma)</option>
                <option value="finance">Finansije</option>
                <option value="court">Sud / advokat</option>
                <option value="idea">Ideja</option>
                <option value="other">Ostalo</option>
              </select>
            </div>
            <div class="field">
              <label>Kategorija</label>
              <select id="qaCategory">
                <option>Finansije</option>
                <option selected>Firma</option>
                <option>Dete</option>
                <option>Praznici</option>
                <option>Sud</option>
                <option>Ideje</option>
                <option>Ostalo</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Naziv</label>
              <input id="qaTitle" placeholder="npr. Termin: Kać, Mose Pijade 59, curi bojler" />
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Datum i vreme</label>
              <input id="qaStart" type="datetime-local" />
            </div>
            <div class="field">
              <label>Trajanje (min)</label>
              <input id="qaDuration" type="number" value="90" />
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Napomena (adresa/stan/sprat/telefon/vrsta kvara)</label>
              <textarea id="qaNote" placeholder="Adresa: ...&#10;Telefon: ...&#10;Sprat/Stan: ...&#10;Kvar: ..."></textarea>
            </div>
          </div>

          <div id="financeFields" style="display:none;">
            <div class="hr"></div>
            <h3>Finansije</h3>
            <div class="row">
              <div class="field">
                <label>Iznos (RSD) — rashod piši negativno (npr -16700)</label>
                <input id="qaAmount" type="number" placeholder="-16700" />
              </div>
            </div>

            <div class="hr"></div>
            <h3>Uplatnica (opciono)</h3>
            <div class="muted">Popuni jednom – generiše se slika uplatnice uz događaj.</div>
            <div class="row">
              <div class="field"><label>Uplatilac</label><input id="slPayer" value="Dule" /></div>
              <div class="field"><label>Adresa</label><input id="slAddr" value="Adresa" /></div>
            </div>
            <div class="row">
              <div class="field"><label>Primalac</label><input id="slRec" placeholder="npr. Ime i prezime / firma" /></div>
              <div class="field"><label>Račun</label><input id="slAcc" placeholder="xxx-xxxxxxxxxxxx-xx" /></div>
            </div>
            <div class="row">
              <div class="field"><label>Svrha</label><input id="slPur" placeholder="npr. Alimentacija" /></div>
              <div class="field"><label>Model</label><input id="slMod" placeholder="97" /></div>
            </div>
            <div class="row">
              <div class="field"><label>Poziv na broj</label><input id="slRef" placeholder="..." /></div>
            </div>
          </div>

          <div class="row" style="margin-top:12px;">
            <button id="btnAdd" class="btn accent">Dodaj</button>
            <span class="muted">Sve se čuva lokalno (vault).</span>
          </div>
        </div>
      </div>

      <!-- FINANCE -->
      <div class="section" id="tab-finance">
        <div class="grid">
          <div class="box">
            <h3>Finansije (tekući mesec)</h3>
            <div class="row" id="financeSummary"></div>
            <div class="muted">Prihod = pozitivan iznos. Rashod = negativan iznos.</div>
          </div>

          <div class="box">
            <h3>Sledeće finansije (120 dana)</h3>
            <div id="financeList" class="list"></div>
          </div>
        </div>
      </div>

      <!-- CHILD -->
      <div class="section" id="tab-child">
        <div class="grid">
          <div class="box">
            <h3>Dete</h3>
            <div class="muted">Generator radi po seed-u koji si dao: vikend 23.01.2026 + sreda 28.01.2026 (svaka 2 nedelje).</div>
            <div class="hr"></div>
            <div class="row">
              <button id="btnGenChild" class="btn accent">Generiši 3 meseca rasporeda</button>
              <button id="btnGenHolidays" class="btn">Generiši praznike 2026 (Opcija A)</button>
            </div>
            <div class="warn" style="margin-top:10px;">Praznici rotiraju: Božić je bio kod žene → sledeći praznik kod tebe → pa kod nje… (09–18).</div>
          </div>

          <div class="box">
            <h3>Sledeće (dete/praznici)</h3>
            <div id="childList" class="list"></div>
          </div>
        </div>
      </div>

      <!-- SETTINGS -->
      <div class="section" id="tab-settings">
        <div class="box">
          <h3>Podešavanja / Backup</h3>
          <div class="row">
            <button id="btnFixedBills" class="btn">Ubaci fiksne obaveze (ovaj mesec)</button>
            <button id="btnExport" class="btn ok">Export JSON</button>
          </div>
          <div class="hr"></div>
          <label>Import JSON (nalepi i uvezi)</label>
          <textarea id="importArea" placeholder="{ ... }"></textarea>
          <div class="row" style="margin-top:10px;">
            <button id="btnImport" class="btn accent">Import</button>
            <button id="btnClear" class="btn danger">Obriši sve (reset)</button>
          </div>
          <div class="muted" style="margin-top:10px;">
            Napomena: Ovo je MVP bez notifikacija. Kad dođeš kući, ubacujemo Capacitor Android i lokalne podsetnike.
          </div>
        </div>
      </div>

    </div>
  </div>

<script>
/* ------------------------- Vault (localStorage) ------------------------- */
const KEY = "sekretarica_vault_v1";
function fnv1a(str){
  let h = 2166136261;
  for(let i=0;i<str.length;i++){
    h ^= str.charCodeAt(i);
    h = Math.imul(h,16777619);
  }
  return String(h>>>0);
}
function loadVault(){
  try{
    const raw = localStorage.getItem(KEY);
    if(!raw) return { pinHash:null, events:[] };
    const v = JSON.parse(raw);
    if(!v.events) v.events = [];
    return v;
  }catch(e){
    return { pinHash:null, events:[] };
  }
}
function saveVault(v){
  localStorage.setItem(KEY, JSON.stringify(v));
}
let VAULT = loadVault();

/* ------------------------- Helpers ------------------------- */
function uid(){
  return Math.random().toString(36).slice(2) + Date.now().toString(36);
}
function pad(n){ return String(n).padStart(2,"0"); }
function fmtLocal(iso){
  const d = new Date(iso);
  if(isNaN(d.getTime())) return iso;
  return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function startOfDay(d){
  const x = new Date(d); x.setHours(0,0,0,0); return x;
}
function isToday(iso){
  const d = new Date(iso);
  const s = startOfDay(new Date());
  const e = new Date(s); e.setDate(e.getDate()+1);
  return d>=s && d<e;
}
function withinDays(iso, days){
  const d = new Date(iso);
  const now = new Date();
  const end = new Date(now); end.setDate(end.getDate()+days);
  return d>=now && d<=end;
}
function sortByDateAsc(a,b){ return new Date(a.startAt).getTime() - new Date(b.startAt).getTime(); }

/* ------------------------- Holidays 2026 (Option A) ------------------------- */
const HOLIDAYS_2026_A = [
  { date:"2026-01-01", sr:"Nova godina", en:"New Year's Day", kind:"state" },
  { date:"2026-01-02", sr:"Nova godina (2. dan)", en:"New Year Holiday", kind:"state" },
  { date:"2026-02-15", sr:"Dan državnosti (Sretenje)", en:"Statehood Day", kind:"state" },
  { date:"2026-02-16", sr:"Dan državnosti – neradni", en:"Statehood Day Holiday", kind:"state" },
  { date:"2026-02-17", sr:"Dan državnosti – neradni", en:"Statehood Day Holiday", kind:"state" },
  { date:"2026-05-01", sr:"Praznik rada", en:"Labour Day", kind:"state" },
  { date:"2026-05-02", sr:"Praznik rada (2. dan)", en:"Labour Day Holiday", kind:"state" },
  { date:"2026-11-11", sr:"Dan primirja", en:"Armistice Day", kind:"state" },
  { date:"2026-01-06", sr:"Badnji dan", en:"Christmas Eve (Orthodox)", kind:"religious" },
  { date:"2026-01-07", sr:"Božić (pravoslavni)", en:"Orthodox Christmas", kind:"religious" },
  { date:"2026-01-14", sr:"Srpska Nova godina", en:"Orthodox New Year", kind:"religious" },
  { date:"2026-01-19", sr:"Bogojavljenje", en:"Epiphany (Orthodox)", kind:"religious" },
  { date:"2026-04-10", sr:"Veliki petak", en:"Good Friday (Orthodox)", kind:"religious" },
  { date:"2026-04-11", sr:"Velika subota", en:"Holy Saturday (Orthodox)", kind:"religious" },
  { date:"2026-04-12", sr:"Vaskrs", en:"Orthodox Easter", kind:"religious" },
  { date:"2026-04-13", sr:"Vaskršnji ponedeljak", en:"Easter Monday", kind:"religious" }
].sort((a,b)=>a.date.localeCompare(b.date));

function generateHolidayCustody(){
  // seed: Christmas was with her
  const seedDate = "2026-01-07";
  const seedWho = "her"; // her on seed, then alternate
  let who = seedWho;
  const out = [];
  let idx = HOLIDAYS_2026_A.findIndex(h=>h.date===seedDate);
  if(idx<0) idx=0;

  for(let i=idx;i<HOLIDAYS_2026_A.length;i++){
    if(i!==idx) who = (who==="me"?"her":"me");
    const h = HOLIDAYS_2026_A[i];
    out.push({
      id: uid(),
      type: "child",
      category: "Praznici",
      title: `Praznik: ${h.sr} (${h.kind==="state"?"državni":"verski"}) — dete ${who==="me"?"KOD MENE":"KOD NJE"} (09–18)`,
      startAt: `${h.date}T09:00:00`,
      endAt: `${h.date}T18:00:00`,
      note: "Rotacija praznika (Opcija A)"
    });
  }
  return out;
}

/* ------------------------- Slip Image (canvas) ------------------------- */
function renderSlipToDataUrl(slip){
  const canvas = document.createElement("canvas");
  canvas.width = 1200;
  canvas.height = 700;
  const ctx = canvas.getContext("2d");

  ctx.fillStyle="#fff";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  ctx.fillStyle="#111";
  ctx.font="bold 34px Arial";
  ctx.fillText("UPLATNICA (Sekretarica)",30,55);

  ctx.font="22px Arial";
  function row(label,value,y){
    ctx.fillStyle="#555"; ctx.fillText(label,30,y);
    ctx.fillStyle="#111"; ctx.fillText(value||"-",380,y);
    ctx.strokeStyle="#ddd";
    ctx.beginPath(); ctx.moveTo(30,y+12); ctx.lineTo(1170,y+12); ctx.stroke();
  }

  row("Uplatilac:", slip.payerName, 120);
  row("Adresa:", slip.payerAddress, 170);
  row("Primalac:", slip.recipient, 220);
  row("Svrha uplate:", slip.purpose, 270);
  row("Iznos (RSD):", String(slip.amountRSD||0), 320);
  row("Račun primaoca:", slip.account, 370);
  row("Model:", slip.model, 420);
  row("Poziv na broj:", slip.reference, 470);

  ctx.font="16px Arial";
  ctx.fillStyle="#666";
  ctx.fillText("Otvori na telefonu i prepiši u pošti/banci/menjačnici.",30,650);

  return canvas.toDataURL("image/png");
}
function openImage(dataUrl){
  const w = window.open("", "_blank");
  if(!w) return;
  w.document.write(`<!doctype html><html><head><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Uplatnica</title></head>
  <body style="margin:0;background:#111;display:flex;align-items:center;justify-content:center;min-height:100vh;">
  <img src="${dataUrl}" style="max-width:100%;height:auto;" />
  </body></html>`);
  w.document.close();
}

/* ------------------------- UI Wiring ------------------------- */
const $ = (id)=>document.getElementById(id);

function setAuthUI(){
  const authTitle = $("authTitle");
  const authHint = $("authHint");
  if(!VAULT.pinHash){
    authTitle.textContent = "Postavi PIN (prvi put)";
    authHint.textContent = "Postavi PIN prvi put. Posle ga koristiš za ulaz. Ko zna PIN ima pristup na ovom uređaju.";
    $("btnEnter").textContent = "Sačuvaj";
  } else {
    authTitle.textContent = "Unesi PIN";
    authHint.textContent = "Ko zna PIN ima pristup na ovom telefonu/računaru (localStorage).";
    $("btnEnter").textContent = "Uđi";
  }
}
setAuthUI();

function auth(){
  const pin = $("pinInput").value.trim();
  if(!pin) return alert("Upiši PIN");
  const h = fnv1a(pin);
  if(!VAULT.pinHash){
    VAULT.pinHash = h;
    saveVault(VAULT);
    $("pinInput").value = "";
    enterApp();
    return;
  }
  if(VAULT.pinHash === h){
    $("pinInput").value = "";
    enterApp();
  } else {
    alert("Pogrešan PIN");
  }
}
$("btnEnter").addEventListener("click", auth);
$("pinInput").addEventListener("keydown", (e)=>{ if(e.key==="Enter") auth(); });

function enterApp(){
  $("authBox").style.display="none";
  $("app").style.display="block";
  $("btnLock").style.display="inline-block";
  renderAll();
}
$("btnLock").addEventListener("click", ()=>{
  $("app").style.display="none";
  $("authBox").style.display="block";
  $("btnLock").style.display="none";
  setAuthUI();
});

document.querySelectorAll(".tab").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    btn.classList.add("active");
    const tab = btn.dataset.tab;
    document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
    $("tab-"+tab).classList.add("active");
  });
});

/* ------------------------- Data ops ------------------------- */
function addEvent(ev){
  VAULT.events.unshift(ev);
  saveVault(VAULT);
  renderAll();
}
function deleteEvent(id){
  VAULT.events = VAULT.events.filter(e=>e.id!==id);
  saveVault(VAULT);
  renderAll();
}
function toggleDone(id){
  VAULT.events = VAULT.events.map(e=>e.id===id ? {...e, done: !e.done} : e);
  saveVault(VAULT);
  renderAll();
}

/* ------------------------- Render items ------------------------- */
function renderItem(e){
  const amount = (e.type==="finance" && typeof e.amountRSD==="number") ? ` ${e.amountRSD} RSD` : "";
  const doneMark = e.done ? " ✓" : "";
  const meta = `
    <span class="pill"><strong>${e.category}</strong></span>
    <span class="pill">${fmtLocal(e.startAt)}</span>
    ${amount ? `<span class="pill">${amount}</span>` : ""}
    ${doneMark ? `<span class="pill">DONE</span>` : ""}
  `;
  const note = e.note ? `<div class="note">${escapeHtml(e.note)}</div>` : "";

  const slipBtn = e.slipImageDataUrl ? `<button class="small" data-action="slip" data-id="${e.id}">Uplatnica</button>` : "";

  return `
    <div class="item" style="${e.done ? "opacity:.6;" : ""}">
      <div class="left">
        <div class="title">${escapeHtml(e.title)}</div>
        <div class="meta">${meta}</div>
        ${note}
      </div>
      <div class="actions">
        <button class="small" data-action="done" data-id="${e.id}">${e.done ? "Undo" : "Done"}</button>
        ${slipBtn}
        <button class="small danger" data-action="del" data-id="${e.id}">Obriši</button>
      </div>
    </div>
  `;
}

function bindListActions(container){
  container.querySelectorAll("button[data-action]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-id");
      const action = btn.getAttribute("data-action");
      if(action==="del") deleteEvent(id);
      if(action==="done") toggleDone(id);
      if(action==="slip"){
        const ev = VAULT.events.find(x=>x.id===id);
        if(ev && ev.slipImageDataUrl) openImage(ev.slipImageDataUrl);
      }
    });
  });
}

function renderAll(){
  const now = new Date();

  // Today
  const today = VAULT.events.filter(e=>isToday(e.startAt)).sort(sortByDateAsc);
  $("todayList").innerHTML = today.map(renderItem).join("");
  $("todayEmpty").style.display = today.length ? "none" : "block";
  bindListActions($("todayList"));

  // Upcoming
  const upcoming = VAULT.events.filter(e=>new Date(e.startAt)>=now).sort(sortByDateAsc).slice(0,20);
  $("upcomingList").innerHTML = upcoming.map(renderItem).join("");
  bindListActions($("upcomingList"));

  // Calendar
  const all = [...VAULT.events].sort(sortByDateAsc);
  $("calendarList").innerHTML = all.map(renderItem).join("");
  bindListActions($("calendarList"));

  // Finance summary + list
  const y = now.getFullYear();
  const m = pad(now.getMonth()+1);
  const ym = `${y}-${m}`;
  let income=0, expense=0;
  VAULT.events.forEach(e=>{
    if(e.type!=="finance") return;
    if(!String(e.startAt).startsWith(ym)) return;
    const amt = Number(e.amountRSD||0);
    if(amt>=0) income += amt;
    else expense += Math.abs(amt);
  });
  const net = income - expense;
  $("financeSummary").innerHTML = `
    <span class="pill"><strong>Mesec:</strong> ${ym}</span>
    <span class="pill"><strong>Prihodi:</strong> ${income} RSD</span>
    <span class="pill"><strong>Rashodi:</strong> ${expense} RSD</span>
    <span class="pill"><strong>Bilans:</strong> ${net} RSD</span>
  `;

  const fin = VAULT.events.filter(e=>e.type==="finance" && withinDays(e.startAt,120)).sort(sortByDateAsc);
  $("financeList").innerHTML = fin.map(renderItem).join("");
  bindListActions($("financeList"));

  // Child list
  const child = VAULT.events
    .filter(e=>(e.category==="Dete"||e.category==="Praznici") && new Date(e.startAt)>=now)
    .sort(sortByDateAsc)
    .slice(0,20);
  $("childList").innerHTML = child.map(renderItem).join("");
  bindListActions($("childList"));
}

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* ------------------------- Quick add ------------------------- */
function initQuickDefaults(){
  const d = new Date();
  // datetime-local expects "YYYY-MM-DDTHH:MM"
  $("qaStart").value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
initQuickDefaults();

$("qaType").addEventListener("change", ()=>{
  $("financeFields").style.display = ($("qaType").value==="finance") ? "block" : "none";
});

$("btnAdd").addEventListener("click", ()=>{
  const type = $("qaType").value;
  const category = $("qaCategory").value;
  const title = $("qaTitle").value.trim();
  const start = $("qaStart").value;
  const durationMin = Number($("qaDuration").value||90);
  const note = $("qaNote").value.trim();

  if(!title) return alert("Upiši naziv");
  if(!start) return alert("Upiši datum");
  const startAt = new Date(start);
  if(isNaN(startAt.getTime())) return alert("Neispravan datum");

  const endAt = new Date(startAt);
  endAt.setMinutes(endAt.getMinutes()+durationMin);

  const ev = {
    id: uid(),
    type,
    category,
    title,
    startAt: startAt.toISOString(),
    endAt: endAt.toISOString(),
    note: note || null,
    done: false
  };

  if(type==="finance"){
    const amt = Number($("qaAmount").value||0);
    ev.amountRSD = amt;

    const slip = {
      payerName: $("slPayer").value.trim(),
      payerAddress: $("slAddr").value.trim(),
      recipient: $("slRec").value.trim(),
      purpose: $("slPur").value.trim(),
      amountRSD: amt,
      account: $("slAcc").value.trim(),
      model: $("slMod").value.trim(),
      reference: $("slRef").value.trim()
    };

    // Generate slip if at least recipient/account/purpose exists
    const hasAny = slip.recipient || slip.account || slip.purpose || slip.reference;
    if(hasAny){
      ev.slip = slip;
      try{
        ev.slipImageDataUrl = renderSlipToDataUrl(slip);
      }catch(err){}
    }
  }

  addEvent(ev);

  // reset a bit
  $("qaTitle").value = "";
  $("qaNote").value = "";
  $("qaAmount").value = "";
  initQuickDefaults();
  alert("Sačuvano.");
});

/* ------------------------- Settings actions ------------------------- */
$("btnExport").addEventListener("click", ()=>{
  const json = JSON.stringify(VAULT, null, 2);
  const blob = new Blob([json], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `sekretarica-backup-${Date.now()}.json`;
  a.click();
  URL.revokeObjectURL(url);
});

$("btnImport").addEventListener("click", ()=>{
  try{
    const txt = $("importArea").value.trim();
    if(!txt) return alert("Nalepi JSON");
    const v = JSON.parse(txt);
    if(!v || typeof v!=="object") throw new Error("Bad JSON");
    if(!Array.isArray(v.events)) v.events = [];
    // zadržavamo pinHash iz trenutno važećeg vault-a ako import nema
    if(!v.pinHash) v.pinHash = VAULT.pinHash;
    VAULT = v;
    saveVault(VAULT);
    $("importArea").value = "";
    alert("Uvezeno.");
    renderAll();
  }catch(e){
    alert("Ne mogu da uvezem JSON.");
  }
});

$("btnClear").addEventListener("click", ()=>{
  if(!confirm("Sigurno? Briše sve događaje.")) return;
  VAULT.events = [];
  saveVault(VAULT);
  renderAll();
});

$("btnFixedBills").addEventListener("click", ()=>{
  const now = new Date();
  const y = now.getFullYear();
  const m = now.getMonth()+1;
  const ym = `${y}-${pad(m)}`;

  // fiksno po tvojoj priči (u startu primer)
  const fixed = [
    { title:"Alimentacija", day:10, time:"13:00", amount:-16700, note:"Plaćanje svakog 10. u mesecu." },
    { title:"Izvršitelji + računi", day:20, time:"12:00", amount:-5000, note:"Gas/struja/informatika/telefon." },
    { title:"Kredit", day:24, time:"12:00", amount:-17000, note:"Kredit do 24. u mesecu." }
  ];

  fixed.forEach(f=>{
    const startAt = new Date(`${ym}-${pad(f.day)}T${f.time}:00`);
    const ev = {
      id: uid(),
      type: "finance",
      category: "Finansije",
      title: f.title,
      startAt: startAt.toISOString(),
      endAt: new Date(startAt.getTime()+30*60000).toISOString(),
      note: f.note,
      amountRSD: f.amount,
      done: false
    };
    VAULT.events.unshift(ev);
  });

  saveVault(VAULT);
  renderAll();
  alert("Ubacio sam fiksne obaveze za tekući mesec.");
});

/* ------------------------- Child generators ------------------------- */
$("btnGenChild").addEventListener("click", ()=>{
  const now = new Date();
  const end = new Date(now);
  end.setMonth(end.getMonth()+3);

  // seed: this weekend is yours Fri 18 -> Sun 18
  const seedWeekend = new Date("2026-01-23T18:00:00");
  for(let d = new Date(seedWeekend); d <= end; d.setDate(d.getDate()+14)){
    const fri = new Date(d);
    const sun = new Date(d); sun.setDate(sun.getDate()+2); sun.setHours(18,0,0,0);
    VAULT.events.unshift({
      id: uid(),
      type:"child",
      category:"Dete",
      title:"Dete kod mene – vikend",
      startAt: fri.toISOString(),
      endAt: sun.toISOString(),
      note:"Svaki drugi vikend (seed: 23.01.2026 18:00).",
      done:false
    });
  }

  // seed: Wednesday 16-18 every two weeks
  const seedWed = new Date("2026-01-28T16:00:00");
  for(let d = new Date(seedWed); d <= end; d.setDate(d.getDate()+14)){
    const wed = new Date(d);
    const ew = new Date(d); ew.setHours(18,0,0,0);
    VAULT.events.unshift({
      id: uid(),
      type:"child",
      category:"Dete",
      title:"Dete – sreda",
      startAt: wed.toISOString(),
      endAt: ew.toISOString(),
      note:"Svaka druga sreda (seed: 28.01.2026 16:00).",
      done:false
    });
  }

  saveVault(VAULT);
  renderAll();
  alert("Generisan raspored deteta za 3 meseca.");
});

$("btnGenHolidays").addEventListener("click", ()=>{
  // remove old holiday child events
  VAULT.events = VAULT.events.filter(e=>!(e.category==="Praznici" && e.type==="child"));
  const hol = generateHolidayCustody();
  VAULT.events = hol.concat(VAULT.events);
  saveVault(VAULT);
  renderAll();
  alert("Generisani praznici 2026 (Opcija A) sa rotacijom.");
});

/* If vault has pin and user reloads while already authed? (simple: keep locked) */
</script>
</body>
</html>
